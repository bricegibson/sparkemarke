<!DOCTYPE html>
<html>
<head>
  <title>Score Entry - SparkeMarke</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container mt-4">

  <!-- Header: Student, Teacher, School, Date/Time -->
  <div class="mb-4">
    
    <h2>Score Entry</h2>
    <p>
      <strong>Student:</strong> <%= studentInfo.studentName %><br>
      <strong>Teacher:</strong> <%= studentInfo.teacherName %><br>
      <strong>School:</strong> <%= studentInfo.schoolName || "No School" %><br>
      <strong>Class Code:</strong> <%= studentInfo.classCode || "No Code" %><br>
      <input type="hidden" name="code" id="codeHidden" value="<%= studentInfo.classCode || "" %>"> <!-- hidden input for class code -->
        <%
        const now = new Date();
        const options = { day: "2-digit", month: "short", year: "numeric" };
        const formattedDate = now.toLocaleDateString("en-US", options);
        %>
        <strong>Date:</strong> <%= formattedDate %>

    </p>
  </div>

  <!-- Row with Stats + Exit buttons -->
  <div class="d-flex justify-content-between mb-4">
    <a href="/stats/<%= studentInfo.studentID %>" class="btn btn-primary">Stats</a>
    <% if (loggedInTeacherId) { %>
        <a href="/teacher/<%= studentInfo.teacherID %>" class="btn btn-outline-danger">
        Exit
        </a>
    <% } else { %>
        <a href="/student-logout" class="btn btn-outline-danger">
        Exit
        </a>
    <% } %>
  </div>

    <div id="subjects-container" class="row g-3">
    <% subjects.forEach(subject => { %>
        <div class="col-md-3">
        <div class="card shadow-sm" style="height:500px; overflow:hidden;">
            <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center mb-1">
                <h5 class="card-title mb-0"><%= subject.subjectName %></h5>
                <% if (averages[subject.subjectID]) { %>
                    <span class="<%= getScoreColor(averages[subject.subjectID]) %> fs-4 fw-bold">
                    <%= Math.round(averages[subject.subjectID] * 100) %>%
                    </span>
                <% } else { %>
                    <span class="text-muted small">‚Äî</span>
                <% } %>
                </div>
                
                
                <p class="small mb-2">
                    <form action="/set-goal" method="POST" class="d-flex justify-content-end align-items-center mb-2">
                        <input type="hidden" name="studentId" value="<%= studentInfo.studentID %>">
                        <input type="hidden" name="subjectId" value="<%= subject.subjectID %>">

                        <label class="me-2 mb-0 small">Goal:</label>
                        <div class="d-flex align-items-center" style="gap: 2px;">
                            <input type="number" step="0.01" min="0" max="100" name="studentGoal"
                                value="<%= subject.goal ? Math.round(subject.goal * 100) : '' %>"
                                class="form-control form-control-sm text-end"
                                style="width: 60px; padding-right: 4px;">
                            <span class="small fw-bold">%</span>
                        </div>

                        <button type="submit" class="btn btn-sm btn-outline-primary ms-2">Save</button>
                    </form>

                </p>

                <!-- Entry Form -->
                <form action="/submit-score" method="POST" class="mb-2 flex-shrink-0">
                    <input type="hidden" name="studentId" value="<%= studentInfo.studentID %>">
                    <input type="hidden" name="subjectId" value="<%= subject.subjectID %>">
                    <input type="hidden" name="teacherId" value="<%= studentInfo.teacherID %>">

                    <div class="mb-2">
                    <input type="date" name="scoreDate"
                            value="<%= new Date().toISOString().slice(0,10) %>"
                            class="form-control form-control-sm">
                    </div>

                    <div class="mb-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio"
                            name="scoreType_<%= subject.subjectID %>" value="percent"
                            checked onclick="toggleInputs('<%= subject.subjectID %>', 'percent')">
                        <label class="form-check-label">Score %</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio"
                            name="scoreType_<%= subject.subjectID %>" value="points"
                            onclick="toggleInputs('<%= subject.subjectID %>', 'points')">
                        <label class="form-check-label">Points</label>
                    </div>
                    </div>

                    <!-- Percent input -->
                    <div id="percent_<%= subject.id %>" class="mb-2">
                    <input type="number" step="0.1" name="percentScore"
                            placeholder="% Score" class="form-control form-control-sm">
                    </div>

                    <!-- Points input -->
                    <div id="points_<%= subject.id %>" class="mb-2" style="display:none;">
                    <div class="d-flex align-items-center">
                        <input type="number" step="0.1" name="pointsEarned"
                            placeholder="Earned" class="form-control form-control-sm me-1">
                        <span>/</span>
                        <input type="number" step="0.1" name="pointsPossible"
                            placeholder="Total" class="form-control form-control-sm ms-1">
                    </div>
                    </div>

                    <button type="submit" class="btn btn-success btn-sm w-100">Save</button>
                </form>

                <!-- Scrollable Score History -->
                <div class="flex-grow-1 overflow-auto border-top pt-2 small">
                    <p class="text-muted">Previous Scores (newest first)</p>
                    <ul class="list-unstyled" id="history_<%= subject.subjectID %>">
                    <% if (scoresBySubject && scoresBySubject[subject.subjectID]) { %>
                        <% scoresBySubject[subject.subjectID].forEach(score => { %>
                            <% const pct = Math.round((score.scoreActual || 0) * 100); %>
                            
                            <li class="d-flex justify-content-between align-items-center <%= getScoreColor(score.scoreActual) %>">
                            <div>
                                <strong><%= score.scoreDate %></strong> ‚Äì
                                <% if (score.scorePossible) { %>
                                    <%= score.scoreValue %> / <%= score.scorePossible %> (<%= pct %>%)
                                <% } else { %>
                                    <%= pct %>%
                                <% } %>
                            </div>

                            <% if (loggedInTeacherId) { %>
                                <form action="/delete-score" method="POST" class="m-0">
                                <input type="hidden" name="scoreId" value="<%= score.scoreID %>">
                                <input type="hidden" name="studentId" value="<%= studentInfo.studentID %>">
                                <button type="submit" class="btn btn-sm btn-outline-danger py-0 px-2" title="Delete score">
                                    üóëÔ∏è
                                </button>
                                </form>
                            <% } %>
                            </li>

                        <% }) %>
                    <% } else { %>
                        <li class="text-muted">No scores yet.</li>
                    <% } %>
                    </ul>
                </div>
            </div>
        </div>
        </div>
    <% }) %>
    </div>

    <script>
        function toggleInputs(subjectId, type) {
            document.getElementById(`percent_${subjectId}`).style.display =
                type === 'percent' ? 'block' : 'none';
            document.getElementById(`points_${subjectId}`).style.display =
                type === 'points' ? 'block' : 'none';
        }

        document.querySelectorAll('form[action="/delete-score"]').forEach(form => {
            form.addEventListener("submit", e => {
                if (!confirm("Are you sure you want to delete this score?")) {
                e.preventDefault();
                }
            });
        });
    </script>


</body>
</html>
