<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    .admin-container {
      width: 95%;
      margin: 0 auto; /* center horizontally */
    }

    table th, table td {
      vertical-align: middle;
      font-size: 0.95rem;
    }

  </style>
</head>
<body class="mt-4">

  <div class="admin-container">

    <!-- Header -->
    <header class="d-flex justify-content-between align-items-center mb-4">
      <h2>Admin Panel</h2>
      <div>
        Logged in as: <strong><%= adminUser %></strong>
        <a href="/admin-logout" class="btn btn-outline-secondary btn-sm ms-2">Logout</a>
      </div>
    </header>

    <!-- 3 Column Layout with Cards -->
    <div class="row g-4">
      
      <!-- Column 1: Schools -->
      <div class="col-md-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <h3 class="card-title">Schools</h3>
            <form action="/admin/schools" method="POST" class="mb-3">
              <div class="mb-2">
                <label>School ID</label>
                <input type="text" name="id" required class="form-control">
              </div>
              <div class="mb-2">
                <label>School Name</label>
                <input type="text" name="name" required class="form-control">
              </div>
              <button type="submit" class="btn btn-success btn-sm">Add School</button>
            </form>

            <h5>Existing Schools</h5>
            <ul class="list-group">
              <% if (schools.length === 0) { %>
                <li class="list-group-item">No schools yet.</li>
              <% } else { %>
                <% schools.forEach(s => { %>
                  <li class="list-group-item"><%= s.schoolName %> (ID: <%= s.schoolID %>)</li>
                <% }) %>
              <% } %>
            </ul>
          </div>
        </div>
      </div>

      <!-- Column 2: Teachers -->
      <div class="col-md-5">
        <div class="card shadow-sm">
          <div class="card-body">
            <h3 class="card-title">Teachers</h3>
            <form action="/admin/teachers" method="POST" class="border p-3 rounded bg-light mb-4">

              <!-- Row 1: Teacher ID + Name -->
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="id" class="form-label">Teacher ID</label>
                  <input type="text" id="id" name="id" class="form-control" required placeholder="e.g. TCH123">
                </div>
                <div class="col-md-8">
                  <label for="name" class="form-label">Teacher Name</label>
                  <input type="text" id="name" name="name" class="form-control" required placeholder="e.g. Jane Smith">
                </div>
              </div>

              <!-- Row 2: Grade Level + School -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="gradeLevel" class="form-label">Grade Level</label>
                  <input type="text" id="gradeLevel" name="gradeLevel" class="form-control" placeholder="e.g. K, 1st - 12th">
                </div>
                <div class="col-md-6">
                  <label for="schoolId" class="form-label">School</label>
                  <select id="schoolId" name="schoolId" class="form-select" required>
                    <option value="">-- Choose A School --</option>
                    <% schools.forEach(school => { %>
                      <option value="<%= school.schoolID %>"><%= school.schoolName %></option>
                    <% }) %>
                  </select>
                </div>
              </div>

              <!-- Row 3: Email + Password -->
              <div class="row mb-3">
                <div class="col-md-7">
                  <label for="email" class="form-label">Email Address</label>
                  <input type="email" id="email" name="email" class="form-control" placeholder="teacher@example.com">
                </div>
                <div class="col-md-5">
                  <label for="password" class="form-label">Password</label>
                  <input type="password" id="password" name="password" class="form-control" placeholder="Set password" required>
                </div>
              </div>

              <button type="submit" class="btn btn-primary">Add Teacher</button>
            </form>

            <h5 class="mt-4">Existing Teachers</h5>
            <table class="table table-striped table-bordered align-middle mt-3">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Grade</th>
                  <th>School</th>
                  <th>Email</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% if (teachers && teachers.length > 0) { %>
                  <% teachers.forEach(t => { %>
                    <tr>
                      <td><%= t.teacherID %></td>
                      <td><%= t.teacherName %></td>
                      <td><%= t.teacherGradeLevel || "‚Äî" %></td>
                      <td><%= t.schoolName || "‚Äî" %></td>
                      <td><%= t.teacherEmail || "‚Äî" %></td>
                      <td>
                        <form action="/admin/teachers/<%= t.teacherID %>/delete" method="POST" class="d-inline">
                          <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this teacher?');">
                            üóëÔ∏è
                          </button>
                        </form>

                        <!-- Edit Button (opens modal) -->
                        <button type="button"
                          class="btn btn-sm btn-outline-primary"
                          data-bs-toggle="modal"
                          data-bs-target="#editTeacherModal"
                          data-id="<%= t.teacherID %>"
                          data-name="<%= t.teacherName %>"
                          data-grade="<%= t.teacherGradeLevel || '' %>"
                          data-email="<%= t.teacherEmail || '' %>">
                          ‚úèÔ∏è
                        </button>

                      </td>
                    </tr>
                  <% }) %>
                <% } else { %>
                  <tr><td colspan="6" class="text-center text-muted">No teachers found.</td></tr>
                <% } %>
              </tbody>
            </table>

            <!-- Edit Teacher Modal -->
            <div class="modal fade" id="editTeacherModal" tabindex="-1" aria-labelledby="editTeacherLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form id="editTeacherForm" method="POST">
                    <div class="modal-header">
                      <h5 class="modal-title" id="editTeacherLabel">Edit Teacher</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <input type="hidden" name="teacherID" id="editTeacherID">

                      <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" name="teacherName" id="editTeacherName" class="form-control" required>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Grade Level</label>
                        <input type="text" name="teacherGradeLevel" id="editTeacherGrade" class="form-control">
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="teacherEmail" id="editTeacherEmail" class="form-control">
                      </div>
                      <div class="mb-3">
                        <label class="form-label">New Password (leave blank to keep current)</label>
                        <input type="password" name="newPassword" id="editTeacherPassword" class="form-control">
                      </div>

                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Column 3: Subjects -->
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h3 class="card-title">Subjects</h3>
            <form action="/admin/subjects" method="POST" class="mb-3">
              <div class="mb-2">
                <label>Subject Name</label>
                <input type="text" name="name" required class="form-control">
              </div>
              <div class="mb-2">
                <label>Teacher</label>
                <select name="teacherId" required class="form-control">
                  <option value="" disabled selected>Select a teacher</option>
                  <% teachers.forEach(t => { %>
                    <option value="<%= t.teacherID %>"><%= t.teacherName %> - <%= t.schoolName %></option>
                  <% }) %>
                </select>
              </div>
              <button type="submit" class="btn btn-success btn-sm">Add Subject</button>
            </form>

            <h5>Existing Subjects</h5>
            <ul class="list-group">
              <% if (subjects.length === 0) { %>
                <li class="list-group-item">No subjects yet.</li>
              <% } else { %>
                <% subjects.forEach(subj => { %>
                  <li class="list-group-item">
                    <%= subj.subjectName%> - <%= subj.teacherName %> (<%= subj.schoolName %>)
                  </li>
                <% }) %>
              <% } %>
            </ul>
          </div>
        </div>
      </div>

    </div>
  </div>
</body>

  <script>
    // Populate the modal with teacher data
    const editModal = document.getElementById("editTeacherModal");
    editModal.addEventListener("show.bs.modal", event => {
      const button = event.relatedTarget;
      document.getElementById("editTeacherID").value = button.dataset.id;
      document.getElementById("editTeacherName").value = button.dataset.name;
      document.getElementById("editTeacherGrade").value = button.dataset.grade;
      document.getElementById("editTeacherEmail").value = button.dataset.email;
    });
  </script>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const modalEl = document.getElementById("editTeacherModal");
    const modal = new bootstrap.Modal(modalEl);
    const form = document.getElementById("editTeacherForm");

    // üîπ Listen for form submission
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());

      try {
        const res = await fetch("/admin/teachers/update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("Update failed");

        modal.hide(); // ‚úÖ close the modal
        showToast("‚úÖ Teacher updated successfully");
      } catch (err) {
        console.error(err);
        showToast("‚ùå Error updating teacher", true);
      }
    });

    // üîπ Toast utility
    function showToast(message, isError = false) {
      const toastContainer = document.createElement("div");
      toastContainer.className =
        `position-fixed bottom-0 end-0 p-3`;
      toastContainer.innerHTML = `
        <div class="toast align-items-center text-white ${isError ? "bg-danger" : "bg-success"} border-0" role="alert">
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      `;
      document.body.appendChild(toastContainer);

      const toastEl = toastContainer.querySelector(".toast");
      const toast = new bootstrap.Toast(toastEl, { delay: 2500 });
      toast.show();

      toastEl.addEventListener("hidden.bs.toast", () => toastContainer.remove());
    }
  });
  </script>

</html>
