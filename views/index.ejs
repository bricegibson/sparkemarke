<!DOCTYPE html>
<html>
<head>
  <title>Grade Manager - SparkeMarke</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

  <style>
    /* Smooth fade-in for the student section */
    #studentSection {
      opacity: 0;
      transition: opacity 0.6s ease-in;
    }
    #studentSection.visible {
      opacity: 1;
    }
  </style>

</head>
<body class="container mt-5">

  <h1 class="mb-4">Welcome to SparkeMarke!</h1>

  <!-- Code Entry -->
  <form id="codeForm" class="mb-4">
    <div class="mb-3">
      <label for="code" class="form-label">Enter Code</label>
      <input type="text" id="code" name="code" maxlength="5" required class="form-control" placeholder="ABCDE">
    </div>
    <button type="submit" class="btn btn-primary">Check Code</button>

    <!-- Spinner -->
    <div id="spinner" class="mt-3 text-center" style="display: none;">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Checking...</span>
      </div>
      <p class="mt-2">Verifying code...</p>
    </div>

  </form>

  <div id="message" class="mt-3"></div>

  <!-- Student Selection (hidden initially) -->
  <div id="studentSection" class="mb-4" style="display:none;">
    <form action="/student-login" method="POST">
      <input type="hidden" name="teacherId" id="teacherId">
      <input type="hidden" name="code" id="codeHidden"> 

      <div class="mb-3">
        <label for="studentId" class="form-label">Select Your Name</label>
        <select name="studentId" id="studentId" required class="form-select">
          <option value="">-- choose a student --</option>
        </select>
      </div>

      <button type="submit" class="btn btn-success">Continue</button>
    </form>
  </div>

  <div id="message" class="mt-3 text-danger"></div>

  <script>
    const spinner = document.getElementById("spinner");
    const messageDiv = document.getElementById("message");
    const studentSection = document.getElementById("studentSection");
    studentSection.classList.remove("visible");

    document.getElementById("codeForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const code = document.getElementById("code").value.trim().toUpperCase();
      messageDiv.textContent = "";
      spinner.style.display = "block"; // ðŸ”¹ Show spinner
      studentSection.style.display = "none";

      try {
        const res = await fetch("/api/check-code", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ code }),
        });

        const data = await res.json();
        spinner.style.display = "none"; // ðŸ”¹ Hide spinner after response

        if (!data.valid) {
          messageDiv.className = "mt-3 text-danger fw-bold";
          messageDiv.textContent = data.message || "Invalid code.";
          return;
        }

        // after success:
        messageDiv.className = "mt-3 text-success fw-bold";
        messageDiv.innerHTML = `âœ… Code verified for <strong>${data.teacherName || "your teacher"}'s</strong> class.`;

        // populate dropdownâ€¦
        const select = document.getElementById("studentId");
        select.innerHTML = '<option value="">-- choose a student --</option>';
        data.students.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.studentID;
          opt.textContent = s.studentName;
          select.appendChild(opt);
        });

        // store teacherId + code for the POST /student-login
        document.getElementById("teacherId").value = data.teacherId;
        document.getElementById("codeHidden").value = code.trim().toUpperCase();  // â¬…ï¸ IMPORTANT

        studentSection.style.display = "block";
        setTimeout(() => studentSection.classList.add("visible"), 50);

      } catch (err) {
        spinner.style.display = "none";
        messageDiv.className = "mt-3 text-danger fw-bold";
        messageDiv.textContent = "Server error. Please try again.";
        console.error(err);
      }
    });
  </script>


</body>
</html>
